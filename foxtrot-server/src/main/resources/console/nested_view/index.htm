<!DOCTYPE html>
<!--
* Copyright 2014 Flipkart Internet Pvt. Ltd.
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
* http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
-->
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author" content="">

<title>Foxtrot Cluster</title>

<!-- Bootstrap core CSS -->
<link href="../css/bootstrap.min.css" rel="stylesheet">
<link href="../css/bootstrap-select.min.css" rel="stylesheet">
<link href="../css/bootstrap-datetimepicker.min.css">
<link href="../css/jquery-ui.css" rel="stylesheet">
<link href="../css/bootstrapValidator.min.css" rel="stylesheet">
<link href="../css/foxtrot.css" rel="stylesheet">
<script src="http://d3js.org/d3.v3.min.js"></script>
<link rel="stylesheet" type="text/css"
      href="https://fonts.googleapis.com/css?family=Open+Sans:400,600">
<link rel="stylesheet" type="text/css" href="sunburst.css"/>
</head>

<body>

<div class="container container-fluid">

    <nav class="navbar navbar-default">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active"><a href="#">Foxtrot</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="../fql">FQL</a></li>
                <li><a href="../cluster">Cluster</a></li>
                <li><a href="../nested_view">Grouping View</a></li>
            </ul>
        </div>
    </nav>

    <div class="row col-md-12">
        <table class="table table-condensed center-block grouping_table_meta">
            <tbody>
                <tr>
                    <td class="control-table-cell">
                        <label for="table_name"><strong>Select Table</strong></label>
                        <select data-style="btn-success" id="table_name"></select>
                    </td>
                    <td class="control-table-cell">
                        <label for="grouping-fields"><strong>Select Grouping Fields</strong></label>
                        <select data-style="btn-primary" id="grouping-fields" multiple="multiple"></select>
                    </td>
                    <td style="height: 100%">
                        <button style="display:inline-block; vertical-align: middle;" class="btn btn-danger"
                                id="grouping-button" name="grouping-button">Execute
                        </button>
                    </td>
                </tr>
            </tbody>
        </table>
        <table class="table grouping_table_data">
            <tbody>
                <tr id="grouping-view">
                    <td>
                        <div class="grouping-view-main">
                            <div class="grouping-view-sequence"></div>
                            <div class="grouping-view-chart">
                            </div>
                        </div>
                        <div class="grouping-view-sidebar">
                            <input type="checkbox" class="grouping-view-toggle-legend">Legend<br/>

                            <div class="grouping-view-legend" style="visibility: hidden;"></div>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="../js/jquery.js"></script>
<script src="../js/bootstrap/bootstrap.min.js"></script>
<script src="../js/bootstrap/bootstrap-select.min.js"></script>
<script src="../js/bootstrap/bootstrap-multiselect.js"></script>
<script src="../js/handlebars-v1.3.0.js"></script>
<script src="../js/handlebars-helper.js"></script>
<script src="../js/randomColor.min.js"></script>
<script src="../js/eventbus.js"></script>
<script src="sunburst.js"></script>
<script>

    $("#table_name").selectpicker();
    $("#table_name").on("change", loadFieldList);

    $("#grouping-fields").selectpicker();
    $("#grouping-button").on("click", handleLoadSunburst);

    $(document).ready(loadTableList);

    function handleLoadSunburst(event) {
        event.preventDefault();
        loadSunburst();
        return false;
    }

    function loadSunburst() {
        var table = $('#table_name').find('option:selected').text();
        var nesting = [];
        $('#grouping-fields').find(':selected').each(function (i, selected) {
            nesting[i] = $(selected).text();
        });

        var query = {
            "opcode": "group",
            "table": table,
            "nesting": nesting
        };

        console.log(query);

        $.ajax({
            dataType: 'json',
            type: 'POST',
            url: '/foxtrot/v1/analytics',
            contentType: "application/json",
            timeout: 30000,
            data: JSON.stringify(query),

            success: function (data) {
                new Sunburst("grouping-view").render(data);
            }
        });
    }

    function loadTableList() {
        $.ajax({
            type: 'GET',
            url: '/foxtrot/v1/tables',
            success: function (data) {
                for (var index in data) {
                    $('#table_name').append($('<option>',
                            {
                                value: data[index]['name'],
                                text: data[index]['name']
                            }
                    ));
                }
                $('#table_name').selectpicker('refresh');
            }
        });
    }

    function loadFieldList() {
        var selected_table = $('#table_name').find('option:selected').text();
        $.ajax({
            type: 'GET',
            url: '/foxtrot/v1/tables/' + selected_table + "/fields",
            success: function (data) {
                var mappings = data['mappings'];
                for (var index in mappings) {
                    $('#grouping-fields').append($('<option>',
                            {
                                value: mappings[index]['field'],
                                text: mappings[index]['field']
                            }
                    ));
                }
                $('#grouping-fields').selectpicker('refresh');
            }
        });
    }

</script>


</body>
</html>